name: Build and Deploy to OpenShift

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  # ===========================================
  # JOB 1: Bygg Backend
  # ===========================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.BACKEND_IMAGE }}:latest

  # ===========================================
  # JOB 2: Bygg Frontend
  # ===========================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.FRONTEND_IMAGE }}:latest

  # ===========================================
  # JOB 3: Deploy till OpenShift
  # ===========================================
  deploy:
    name: Deploy to OpenShift
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: 4

      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} \
                   --server=${{ secrets.OPENSHIFT_SERVER }} \
                   --insecure-skip-tls-verify=true

      - name: Select project
        run: |
          oc project ${{ secrets.OPENSHIFT_NAMESPACE }}

      - name: Create Secrets
        run: |
          # Ta bort gamla secrets om de finns
          oc delete secret db-secrets --ignore-not-found=true
          oc delete secret redis-secrets --ignore-not-found=true
          
          # Skapa nya secrets
          oc create secret generic db-secrets \
            --from-literal=POSTGRESQL_USER=guestbook \
            --from-literal=POSTGRESQL_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --from-literal=POSTGRESQL_DATABASE=guestbook
          
          oc create secret generic redis-secrets \
            --from-literal=REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

      - name: Deploy PostgreSQL
        run: |
          oc apply -f deployment/postgres-deployment.yaml
          oc apply -f deployment/postgres-service.yaml

      - name: Deploy Redis
        run: |
          oc apply -f deployment/redis-deployment.yaml
          oc apply -f deployment/redis-service.yaml

      - name: Deploy Backend
        run: |
          # Uppdatera image i deployment
          sed -i "s|image:.*|image: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}|g" \
            deployment/backend-deployment.yaml
          
          oc apply -f deployment/backend-deployment.yaml
          oc apply -f deployment/backend-service.yaml

      - name: Deploy Frontend
        run: |
          # Uppdatera image i deployment
          sed -i "s|image:.*|image: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}|g" \
            deployment/frontend-deployment.yaml
          
          oc apply -f deployment/frontend-deployment.yaml
          oc apply -f deployment/frontend-service.yaml
          oc apply -f deployment/route.yaml

      - name: Wait for deployments
        run: |
          echo "Väntar på PostgreSQL..."
          oc rollout status deployment/postgres --timeout=120s
          
          echo "Väntar på Redis..."
          oc rollout status deployment/redis --timeout=120s
          
          echo "Väntar på Backend..."
          oc rollout status deployment/backend --timeout=120s
          
          echo "Väntar på Frontend..."
          oc rollout status deployment/frontend --timeout=120s

      - name: Show deployment status
        run: |
          echo "=== PODS ==="
          oc get pods
          
          echo ""
          echo "=== SERVICES ==="
          oc get services
          
          echo ""
          echo "=== ROUTE ==="
          oc get route
          
          ROUTE_URL=$(oc get route frontend -o jsonpath='{.spec.host}')
          echo ""
          echo "Application URL: https://$ROUTE_URL"
